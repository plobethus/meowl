{% extends "base.html" %}
{% block content %}
<div class="container">
  <h1>Staff Dashboard</h1>

  <!-- Meowls -->
  <section class="card">
    <h2>Meowls</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Slug</th>
          <th>Owner</th>
          <th>Comments</th>
          <th>Status</th>
          <th style="white-space:nowrap;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for m in meowls %}
        <tr>
          <td><a href="{% url 'meowls:detail' m.slug %}">{{ m.name }}</a></td>
          <td><a href="{% url 'meowls:detail' m.slug %}">{{ m.slug }}</a></td>
          <td>{{ m.owner.username }}</td>
          <td>{{ m.visible_comments|default:0 }}</td>
          <td>
            {% if m.is_archived %}
            <span class="muted">Archived</span>
            {% else %}
            Active
            {% endif %}
          </td>
          <td style="white-space:nowrap; display:flex; gap:8px;">
            <a class="btn btn-small" href="{% url 'meowls:detail' m.slug %}">View</a>

            {% if m.is_archived %}
            <form method="post" action="{% url 'meowls:unarchive_meowl' m.slug %}">
              {% csrf_token %}
              <button class="btn btn-small">Unarchive</button>
            </form>
            {% else %}
            <form method="post" action="{% url 'meowls:archive_meowl' m.slug %}">
              {% csrf_token %}
              <button class="btn btn-small">Archive</button>
            </form>
            {% endif %}

            <a class="btn btn-small" href="{% url 'meowls:pdf_preview' m.slug %}">PDF</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6"><em>No Meowls yet.</em></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- Recent Comments -->
  <section class="card" style="margin-top:24px;">
    <h2>Recent Comments</h2>
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th>Meowl</th>
          <th>Text</th>
          <th>Status</th>
          <th style="white-space:nowrap;">Moderation</th>
        </tr>
      </thead>
      <tbody>
        {% for c in recent_comments %}
        <tr>
          <td>{{ c.id }}</td>
          <td>{{ c.user.username }}</td>
          <td><a href="{% url 'meowls:detail' c.meowl.slug %}">{{ c.meowl.slug }}</a></td>
          <td style="max-width:480px; overflow-wrap:anywhere;">{{ c.text|truncatechars:140 }}</td>
          <td>{% if c.is_hidden %}<span class="muted">Hidden</span>{% else %}Visible{% endif %}</td>
          <td style="white-space:nowrap;">
            {% if c.is_hidden %}
            <form method="post" action="{% url 'meowls:unhide_comment' c.id %}" style="display:inline-block;">
              {% csrf_token %}
              <button class="btn btn-small">Unhide</button>
            </form>
            {% else %}
            <form method="post" action="{% url 'meowls:hide_comment' c.id %}" style="display:inline-block;">
              {% csrf_token %}
              <input type="text" name="reason" placeholder="Reason (optional)" maxlength="200" style="width:220px;">
              <button class="btn btn-small">Hide</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6"><em>No comments.</em></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- Audit Log -->
  <section class="card" style="margin-top:24px;">
    <h2>Audit Log</h2>
    <table class="table">
      <thead>
        <tr>
          <th>When</th>
          <th>Actor</th>
          <th>Action</th>
          <th>Target</th>
          <th>Detail</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.created_at|date:"Y-m-d H:i" }}</td>
          <td>{{ log.actor.username|default:"(system)" }}</td>
          <td>{{ log.action }}</td>
          <td>
            {% if log.target_user %}user={{ log.target_user.username }} {% endif %}
            {% if log.meowl %}meowl={{ log.meowl.slug }} {% endif %}
            {% if log.comment_id %}comment=#{{ log.comment_id }}{% endif %}
          </td>
          <td style="max-width: 480px; overflow-wrap:anywhere;">{{ log.detail }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5"><em>No log entries yet.</em></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

 <!-- Users -->
<section class="card" style="margin-top:24px;">
  <h2>Users</h2>
  <p class="muted">Only superusers can change staff status. Staff can suspend/unsuspend users.</p>

  <table class="table">
    <thead>
      <tr>
        <th>Username</th>
        <th>Staff?</th>
        <th>Superuser?</th>
        <th>Suspended?</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td>{{ u.username }}</td>
        <td>{% if u.is_staff %}Yes{% else %}No{% endif %}</td>
        <td>{% if u.is_superuser %}Yes{% else %}No{% endif %}</td>

        <!-- Suspended? -->
        <td>{% if u.status and u.status.is_suspended %}Yes{% else %}No{% endif %}</td>

        <!-- Actions -->
        <td style="white-space:nowrap; display:flex; gap:8px; align-items:center;">
          {# Suspend / Unsuspend — staff or superuser can do this #}
          {% if request.user.is_staff %}
            <form method="post"
                  action="{% if u.status and u.status.is_suspended %}
                             {% url 'meowls:unsuspend_user' u.id %}
                           {% else %}
                             {% url 'meowls:suspend_user' u.id %}
                           {% endif %}">
              {% csrf_token %}
              <input type="text" name="reason" placeholder="Reason (optional)" maxlength="200" style="width:220px;">
              <button class="btn btn-small">
                {% if u.status and u.status.is_suspended %}Unsuspend{% else %}Suspend{% endif %}
              </button>
            </form>
          {% endif %}

          {# Promote / Demote — superusers only #}
          {% if request.user.is_superuser %}
            {% if u.is_staff %}
              {% if u != request.user %}
                <form method="post" action="{% url 'meowls:demote_user' u.id %}">
                  {% csrf_token %}
                  <button class="btn btn-small btn-danger">Demote</button>
                </form>
              {% else %}
                <span class="muted">(you)</span>
              {% endif %}
            {% else %}
              <form method="post" action="{% url 'meowls:promote_user' u.id %}">
                {% csrf_token %}
                <button class="btn btn-small">Promote</button>
              </form>
            {% endif %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

</div>
{% endblock %}