{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container">
  <h1>{{ meowl.name }}</h1>

  <div class="grid">
    <div>
      <p>{{ meowl.description }}</p>

      <h3>Location</h3>
      {% if meowl.lat and meowl.lng %}
        <p>
          <strong>Lat:</strong> {{ meowl.lat }} &nbsp;
          <strong>Lng:</strong> {{ meowl.lng }}
        </p>
        <div id="map" style="height: 320px; border-radius: 8px;"></div>
      {% else %}
        <p><em>No location set yet.</em></p>
      {% endif %}

      {% if pending_move %}
        <p class="notice">A location change is pending verification.</p>
        <form method="post" action="{% url 'meowls:verify' meowl.slug %}">
          {% csrf_token %}
          <button class="btn">I found it here — verify move (+10)</button>
        </form>
      {% endif %}

      <hr>

      <h3>Comments</h3>
      {% if user.is_authenticated %}
        <form method="post">
          {% csrf_token %}
          {{ form.body }}
          <div style="margin-top:8px;">
            <button class="btn">Post</button>
          </div>
        </form>
      {% else %}
        <p><a href="/accounts/login/?next={{ request.path }}">Log in</a> to comment.</p>
      {% endif %}

      <ul class="comment-list">
        {% for c in comments %}
          <li>
            <div><strong>{{ c.author.username }}</strong> · {{ c.created_at|date:"Y-m-d H:i" }}</div>
            <div>{{ c.body|linebreaksbr }}</div>
            {% if user.is_staff %}
            <form method="post" action="{% url 'meowls:hide_comment' c.id %}" style="margin-top:6px;">
              {% csrf_token %}
              <input type="text" name="reason" placeholder="Reason (optional)" maxlength="200" style="width:60%;">
              <button class="btn btn-small">Hide</button>
            </form>
            {% endif %}
          </li>
        {% empty %}
          <li><em>No comments yet.</em></li>
        {% endfor %}
      </ul>
    </div>

    <aside>
      <div class="card">
        <h3>Actions</h3>
        {% if user.is_authenticated %}
          <form method="post" action="{% url 'meowls:scan' meowl.slug %}">
            {% csrf_token %}
            <button class="btn">I scanned this Meowl (+5)</button>
          </form>
        {% else %}
          <a class="btn" href="/accounts/login/?next={{ request.path }}">Log in to scan</a>
        {% endif %}

        {% if user.is_staff %}
          <hr>
          <a class="btn" href="{% url 'meowls:pdf_preview' meowl.slug %}">PDF (staff)</a>
        {% endif %}

        {% if meowl.archived %}
          <p class="muted">This Meowl is archived.</p>
        {% endif %}
      </div>
    </aside>
  </div>
</div>

{% if meowl.lat and meowl.lng %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map', { zoomControl: true }).setView([{{ meowl.lat }}, {{ meowl.lng }}], 15);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: "&copy; OSM" }).addTo(map);
  L.marker([{{ meowl.lat }}, {{ meowl.lng }}]).addTo(map);
</script>
{% endif %}
{% endblock %}
